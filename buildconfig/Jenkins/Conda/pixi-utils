#!/bin/bash
PATH_TO_HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Download and install pixi
install_pixi() {
  # check if pixi is not installed
  if ! command -v pixi >/dev/null 2>&1
  then
    curl -fsSL https://pixi.sh/install.sh | sh
    if [[ "$OSTYPE" == "darwin"* ]]; then
      PATH=$PATH:$HOME/.pixi/bin
    else
      source ~/.bashrc
    fi
  fi
}

# The pixi.toml (manifest) file we use for ci is build programmatically and not kept in git
# since it modifies itself.
setup_pixi_toml() {
  while [ ! $# -eq 0 ]
  do
    case "$1" in
        --force-regenerate) FORCE_REGENERATE=true ;;
        *)
            echo "Argument not accepted: $1"
            exit 1
            ;;
    esac
    shift
  done

  LOCAL_MANIFEST=$PATH_TO_HERE/pixi.toml
  LOCAL_LOCK=$PATH_TO_HERE/pixi.lock

  if [[ -f $LOCAL_MANIFEST ]]; then
    if [[ $FORCE_REGENERATE=true ]]; then
      rm $LOCAL_MANIFEST
    else
      exit 0
    fi
  fi
  if [[ -f $LOCAL_LOCK ]]; then
    if [[ $FORCE_REGENERATE=true ]]; then
      rm $LOCAL_LOCK
    else
      exit 0
    fi
  fi

  # if you pass pixi init a path it will make a new directory, so cd there instead
  cd $PATH_TO_HERE
  pixi init -c conda-forge -c neutrons -p linux-64 -p win-64 -p osx-arm64
  pixi workspace --manifest-path $LOCAL_MANIFEST name set mantid-ci
  # environment for running rattler-build
  pixi add --manifest-path $LOCAL_MANIFEST -f rattler-builder rattler-build=0.47 rattler-index versioningit
  pixi add --manifest-path $LOCAL_MANIFEST -f rattler-builder -p linux-64 jq
  pixi add --manifest-path $LOCAL_MANIFEST -f rattler-builder -p osx-arm64 jq
  pixi add --manifest-path $LOCAL_MANIFEST -f rattler-builder -p win-64 m2w64-jq
  pixi workspace --manifest-path $LOCAL_MANIFEST environment add rattler-builder --feature rattler-builder --no-default-feature
  # environment for local mantid-developer build to be installed into
  pixi workspace --manifest-path $LOCAL_MANIFEST channel add -f mantid-developer-ci conda-forge
  pixi workspace --manifest-path $LOCAL_MANIFEST channel add -f mantid-developer-ci neutrons
  pixi workspace --manifest-path $LOCAL_MANIFEST environment add mantid-developer-ci --feature mantid-developer-ci --no-default-feature
  cd -

  export
}

create_mantid_developer_ci() {
  MANTID_ROOT=$1
  setup_pixi_toml --force-regenerate
  sh $PATH_TO_HERE/package-conda $MANTID_ROOT --build-mantid-developer
  PLATFORM=$(pixi run --manifest-path $PATH_TO_HERE/pixi.toml -e rattler-builder "pixi info --json | jq -r .platform")
  pixi workspace --manifest-path $PATH_TO_HERE/pixi.toml channel add $MANTID_ROOT/conda-bld -f mantid-developer-ci --prepend
  pixi add --manifest-path $PATH_TO_HERE/pixi.toml --platform $PLATFORM -f mantid-developer-ci mantid-developer
}
